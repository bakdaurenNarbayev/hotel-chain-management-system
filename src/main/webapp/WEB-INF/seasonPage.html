<!DOCTYPE html>
<html>
<head>
	<meta charset="ISO-8859-1">
    <title>Check-Out Page</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" charset="utf8" 
    	src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.js"></script>
    <script type="text/javascript">
	    var link = window.location.href.toString();
		const params = new URLSearchParams(window.location.search);
		var auth = "?auth=" + params.get('auth');
        var season = {}
        var table;
        
        function leave() {
    		window.location='http://localhost:8080/HotelChainManagementSystem/services/profile' + auth;
    	}
        
		function cancel(id) {
        	
        	let url = 'http://localhost:8080/HotelChainManagementSystem/services/season/delete/' +
        	season.seasonName[id] + '-' +
        	season.start[id].substring(0, 4) + ":" + 
        	season.start[id].substring(5, 7) + ':' + 
        	season.start[id].substring(8, 10) + '-' +
        	season.end[id].substring(0, 4) + ":" + 
        	season.end[id].substring(5, 7) + ':' + 
        	season.end[id].substring(8, 10) +
        	auth;
		
        	console.log(url)
    		
    		fetch(url, {
               	method: 'DELETE',
            }).then(() => {
            	window.location.href = link;
            })
            
    	}
        
        function hideDetails() {
        	$('#details-table-body').empty();
        	$('#details-div').attr("style", "display:none");
        }
        
        function showDetails(i) {        	
        	$('#details-div').attr("style", "display:run-in");
        	
        	$('#details-season').html("'" + season.seasonName[i][0].toUpperCase() + season.seasonName[i].substring(1) + "' season. From " + season.start[i] + " to " + season.end[i] + ". Prices:");
        	
        	$.getJSON("http://localhost:8080/HotelChainManagementSystem/services/season/" + season.seasonName[i] + auth, function(data) {
        		season.weekDay = data.weekDay;
        		season.roomType = data.roomType;
        		season.price = data.price;
        		
        		$('#details-table-body').empty();
        		for (let j = 0; j < (season.weekDay.length/7); j++) {
        			var roomType = season.roomType[j*7];
        			var price = {};
        			
        			for (let k = j*7; k < j*7 + 7; k++) {
        				if(season.weekDay[k] == "M")
        					price.mon = season.price[k];
        				if(season.weekDay[k] == "T")
        					price.tue = season.price[k];
        				if(season.weekDay[k] == "W")
        					price.wed = season.price[k];
        				if(season.weekDay[k] == "R")
        					price.thu = season.price[k];
        				if(season.weekDay[k] == "F")
        					price.fri = season.price[k];
        				if(season.weekDay[k] == "S")
        					price.sat = season.price[k];
        				if(season.weekDay[k] == "H")
        					price.sun = season.price[k];
        			}
        			
        			var row = "<tr> <td>" +
 							roomType + "</td> <td>" +
 							"$" + price.mon + "</td> <td>" +
 							"$" + price.tue + "</td> <td>" +
 							"$" + price.wed + "</td> <td>" +
 							"$" + price.thu + "</td> <td>" +
 							"$" + price.fri + "</td> <td>" +
 							"$" + price.sat + "</td> <td>" +
 							"$" + price.sun + "</td> <tr>";
 					$('#details-table-body').append(row);
        		}
        	});
        	
        	
        }
        
        $(document).ready(function () {
            $.getJSON("http://localhost:8080/HotelChainManagementSystem/services/season/all" + auth, function (data) {
            		
            	season.seasonName = data.seasonName;
            	season.start = data.start;
            	season.end = data.end;
            	
            	for (let i = 0; i < season.seasonName.length; i++) {
					var row = "<tr> <td>" +
             			season.seasonName[i] + "</td> <td>" +
             			season.start[i] + "</td> <td>" +
             			season.end[i] + "</td> <td>" +
             			"<button class='details' id=d" + i.toString() + "> Details </button>" + "</td> <td>" +
             			"<button class='cancel cancelbtn' id=" + i.toString() + "> Cancel </button>" + "</td> </tr>";
            		$('#table-body').append(row);
            	}

                table = $('#season-table').DataTable();
                
                // "{guestID}-{roomType}-{roomNumber}-{floor}-{checkInDate}"
                $('.cancel').on('click', function () {
                    console.log('clicked')
                    let r = $(this).closest('tr').index()
                    let id = parseInt(this.id);
                    
                    cancel(id);
                })
                
                $('.details').on('click', function () {
                    console.log('clicked details')
                    let r = $(this).closest('tr').index();
                    let id = parseInt(this.id.substring(1));
                    
                    showDetails(id);
                })
                
        });
            
            $.getJSON("http://localhost:8080/HotelChainManagementSystem/services/season/all" + auth, function (data) {
            	document.getElementById("HotelName").innerHTML =	"Hotel " + '"' +
            														data.hotelName[0] + '"';
            });
        })
        
    </script>
</head>
<body>
<h2>
    Seasonal Discounts
</h2>

<h3 id="HotelName"></h3>

<table class="cell-border" id="season-table">
        <thead>
        <tr>
        	<th>Season Name</th>
        	<th>Start Date</th>
            <th>End Date</th>
            <th>Show details</th>
            <th>Cancel Season</th>
        </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
</table>

<div id="details-div" style="display:none">
	<h3 id="details-season"></h3>
	<table class="details-cell-border" id="details">
        <thead>
        <tr>
        	<th>Room type</th>
        	<th>Monday</th>
            <th>Tuesday</th>
            <th>Wednesday</th>
            <th>Thursday</th>
            <th>Friday</th>
            <th>Saturday</th>
            <th>Sunday</th>
        </tr>
        </thead>
        <tbody id="details-table-body">
        </tbody>
	</table>
	<button class="cancelbtn" id="hide" onclick=hideDetails();>Hide details</button>
</div>

<h4 id="warning" style="color:red;display:none"></h4><br>

<button class="create" id="create" onclick=create();>Create</button>

<button class="cancelbtn" id="cancel" onclick=leave();>Cancel</button>

</body>
</html>