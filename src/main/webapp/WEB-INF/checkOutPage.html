<!DOCTYPE html>
<html>
<head>
	<meta charset="ISO-8859-1">
    <title>Check-Out Page</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" charset="utf8" 
    	src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.js"></script>
    <script type="text/javascript">
        var link = window.location.href.toString();
        var auth = link.substring(66, link.length)
        var occupied = {}
        var table;
        
        function cancel() {
    		window.location='http://localhost:8080/HotelChainManagementSystem/services/profile' + auth;
    	}
        
        $(document).ready(function () {
            $.getJSON("http://localhost:8080/HotelChainManagementSystem/services/checkout/occupied" + auth, function (data) {
            	occupied.guestIDs = data.guestIDs;
            	occupied.guestFullNames = data.guestFullNames;
            	occupied.guestMobilePhoneNumbers = data.guestMobilePhoneNumbers;
            	occupied.roomTypes = data.roomTypeNames;
            	occupied.checkInDates = data.checkInDates;
            	occupied.checkOutDates = data.checkOutDates;
            	occupied.roomNumbers = data.roomNumbers; 
            	occupied.roomFloors = data.roomFloors; 
            	occupied.hotelIDs = data.hotelIDs;
            	occupied.hotelNames = data.hotelNames;

                for (let i = 0; i < occupied.guestFullNames.length; i++) {
                    $('#table-body').append("<tr> <td>" +
                    	occupied.guestIDs[i] + "</td> <td>" +
                    	occupied.guestFullNames[i] + "</td> <td>" +
                    	occupied.guestMobilePhoneNumbers[i] + "</td> <td>" +
                    	occupied.roomTypes[i] + "</td> <td>" +
                    	occupied.roomNumbers[i] + "</td> <td>" +
                    	occupied.roomFloors[i] + "</td> <td>" +
                    	occupied.checkInDates[i] + "</td> <td>" +
                    	occupied.checkOutDates[i] + "</td> <td>" +
                    	"<button class='check-out' id=" + i.toString() + "> Check-Out </button>" + "</td> </tr>");
                }
            
                table = $('#book-table').DataTable();
                
                // "{guestID}-{roomType}-{roomNumber}-{floor}-{checkInDate}"
                $('.check-out').on('click', function () {
                    console.log('clicked')
                    let r = $(this).closest('tr').index()
                    let id = parseInt(this.id);
                    let url = 'http://localhost:8080/HotelChainManagementSystem/services/checkout/' +
                    	occupied.guestIDs[id].toString().replace(/ /g, ':') + '-' +
                    	occupied.roomTypes[id].replace(/ /g, ':') + '-' +
                    	occupied.roomNumbers[id].replace(/ /g, ':') + '-' +
                    	occupied.roomFloors[id].toString().replace(/ /g, ':') + '-' +
                    	occupied.checkInDates[id].substring(0, 4) + ":" + occupied.checkInDates[id].substring(5, 7) + ':' + occupied.checkInDates[id].substring(8, 10) + //'-' +
                        //bookings.checkOutDates[id].substring(0, 4) + ":" + bookings.checkOutDates[id].substring(5, 7) + ':' + bookings.checkOutDates[id].substring(8, 10) + '-' +
                        //bookings.roomTypes[id] + 
                        auth;
					
                    console.log(url)
                        
                    fetch(url, {
                        method: 'POST',
                    }).then(() => {
                        table.row(r).remove().draw();
                    })

                })
        });
            
            $.getJSON("http://localhost:8080/HotelChainManagementSystem/services/book-management/hotel-choosing-info" + auth, function (data) {
            	document.getElementById("HotelName").innerHTML = 	data.country + ", " +
            														data.region + ", " +
            														"Hotel " + '"' +
            														data.name + '"';
            });
            
        })
        
    </script>
</head>
<body>
<h2>
    Occupied Rooms
</h2>

<h3 id="HotelName"></h3>

<table class="cell-border" id="book-table">
        <thead>
        <tr>
        	<th>Guest ID</th>
        	<th>Full Name</th>
        	<th>Mobile Phone Number</th>
            <th>Room Type</th>
            <th>Room Number</th>
            <th>Floor</th>
            <th>Check In Date</th>
            <th>Check Out Date</th>
            <th>Check Out</th>
        </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
</table>

<button class="cancelbtn" id="cancel" onclick=cancel();>Cancel</button>
</body>
</html>